<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒèº«ä»½ç‹¼äººæ€ - äº‘ç«¯ç‰ˆ</title>
    
    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av-min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .mode-selector {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }

        .mode-btn {
            padding: 15px 40px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .mode-btn.judge {
            background: #3498db;
            color: white;
        }

        .mode-btn.player {
            background: #e74c3c;
            color: white;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .section.active {
            display: block;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .alert-info {
            background: #d1ecf1;
            border-left: 4px solid #0c5460;
            color: #0c5460;
        }

        .alert-success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }

        .card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid #dee2e6;
        }

        .role-card {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 6px;
            font-weight: bold;
        }

        .role-card.wolf {
            background: #e74c3c;
            color: white;
        }

        .role-card.good {
            background: #27ae60;
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        table th, table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: white;
            border: 2px solid #3498db;
            color: #3498db;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .back-btn:hover {
            background: #3498db;
            color: white;
        }

        #qrcode {
            text-align: center;
            margin: 20px 0;
        }

        .share-url {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            word-break: break-all;
            border: 2px dashed #3498db;
        }

        .share-url strong {
            color: #3498db;
            font-size: 18px;
        }

        .copy-btn {
            background: #27ae60;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .copy-btn:hover {
            background: #229954;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¦–é¡µ -->
        <div id="home-section" class="section active">
            <div class="header">
                <h1>ğŸ® åŒèº«ä»½ç‹¼äººæ€ - äº‘ç«¯ç‰ˆ</h1>
                <p style="color: #666; margin-top: 10px;">
                    â˜ï¸ äº‘ç«¯å­˜å‚¨ | ğŸ” å¯†ç ä¿æŠ¤ | ğŸ“± è·¨è®¾å¤‡åŒæ­¥
                </p>
                <div class="mode-selector">
                    <button class="mode-btn judge" onclick="selectMode('judge')">
                        ğŸ¯ æˆ‘æ˜¯æ³•å®˜
                    </button>
                    <button class="mode-btn player" onclick="selectMode('player')">
                        ğŸ® æˆ‘æ˜¯ç©å®¶
                    </button>
                </div>
            </div>
            
            <div class="alert alert-info">
                <strong>âœ¨ å…¨æ–°äº‘ç«¯ç‰ˆç‰¹æ€§ï¼š</strong><br>
                â€¢ æ— éœ€ä¸‹è½½ï¼Œæµè§ˆå™¨ç›´æ¥è®¿é—®<br>
                â€¢ æ•°æ®å­˜å‚¨åœ¨äº‘ç«¯ï¼Œæ°¸ä¸ä¸¢å¤±<br>
                â€¢ æ”¯æŒä»»ä½•è®¾å¤‡ï¼šæ‰‹æœºã€å¹³æ¿ã€ç”µè„‘<br>
                â€¢ 4ä½æ•°å­—å¯†ç ä¿æŠ¤<br>
                â€¢ å®æ—¶è·¨è®¾å¤‡åŒæ­¥
            </div>
        </div>

        <!-- æ³•å®˜é…ç½®é¡µ -->
        <div id="judge-config-section" class="section">
            <button class="back-btn" onclick="goHome()">â† è¿”å›</button>
            
            <h2>ğŸ¯ æ³•å®˜é…ç½®æ¸¸æˆ</h2>
            
            <div class="input-group">
                <label>ç©å®¶äººæ•°</label>
                <input type="number" id="player-count" min="6" max="20" value="10">
            </div>

            <div class="input-group">
                <label>æ¸¸æˆä¼šè¯IDï¼ˆåˆ†äº«ç»™ç©å®¶ï¼‰</label>
                <input type="text" id="session-id" readonly>
                <button class="copy-btn" onclick="copySessionId()">ğŸ“‹ å¤åˆ¶</button>
            </div>

            <div class="card">
                <h3>ç©å®¶è®¿é—®åœ°å€ï¼š</h3>
                <div class="share-url">
                    <strong id="player-url"></strong>
                    <button class="copy-btn" onclick="copyPlayerUrl()">ğŸ“‹ å¤åˆ¶é“¾æ¥</button>
                </div>
            </div>

            <button class="btn btn-success" onclick="generateGame()">
                ğŸ² ç”Ÿæˆæ¸¸æˆå¹¶åˆ†é…èº«ä»½
            </button>

            <div id="passwords-section" style="display: none;">
                <div class="alert alert-warning">
                    <strong>ğŸ”‘ ç©å®¶å¯†ç åˆ—è¡¨ï¼ˆè¯·å‘Šè¯‰ç©å®¶ï¼‰ï¼š</strong>
                    <div id="passwords-list"></div>
                </div>
            </div>

            <div id="judge-status" style="display: none;">
                <h3>ğŸ“Š ç©å®¶é€‰æ‹©çŠ¶æ€</h3>
                <div id="status-table"></div>
                <button class="btn btn-primary" onclick="refreshStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
            </div>
        </div>

        <!-- ç©å®¶ç™»å½•é¡µ -->
        <div id="player-login-section" class="section">
            <button class="back-btn" onclick="goHome()">â† è¿”å›</button>
            
            <h2>ğŸ® ç©å®¶ç™»å½•</h2>
            
            <div class="alert alert-info">
                <strong>è¯´æ˜ï¼š</strong><br>
                1. è¾“å…¥æ³•å®˜ç»™ä½ çš„ä¼šè¯ID<br>
                2. è¾“å…¥ä½ çš„å·ç å’Œå¯†ç <br>
                3. æŸ¥çœ‹å¹¶é€‰æ‹©ä½ çš„èº«ä»½ç‰Œ
            </div>

            <div class="input-group">
                <label>æ¸¸æˆä¼šè¯ID</label>
                <input type="text" id="player-session-id" placeholder="è¾“å…¥æ³•å®˜ç»™ä½ çš„ä¼šè¯ID">
            </div>

            <div class="input-group">
                <label>ä½ çš„å·ç </label>
                <input type="number" id="player-number" min="1" max="20" placeholder="è¾“å…¥å·ç ï¼ˆå¦‚ï¼š1ï¼‰">
            </div>

            <div class="input-group">
                <label>å¯†ç </label>
                <input type="text" id="player-password" maxlength="4" placeholder="è¾“å…¥4ä½å¯†ç ">
            </div>

            <button class="btn btn-success" onclick="playerLogin()">
                ğŸ´ æŸ¥çœ‹æˆ‘çš„èº«ä»½
            </button>
        </div>

        <!-- ç©å®¶é€‰æ‹©é¡µ -->
        <div id="player-selection-section" class="section">
            <button class="back-btn" onclick="playerLogout()">â† é€€å‡ºç™»å½•</button>
            
            <h2>ğŸ­ ä½ çš„èº«ä»½ç‰Œ</h2>
            
            <div class="alert alert-warning">
                <strong>âš ï¸ è¯·ä¿å¯†ï¼</strong>ä¸è¦è®©å…¶ä»–ç©å®¶çœ‹åˆ°ä½ çš„å±å¹•ï¼
            </div>

            <div id="player-cards"></div>

            <div id="selection-area">
                <h3>é€‰æ‹©ä½ çš„ä¸Šç‰Œå’Œä¸‹ç‰Œï¼š</h3>
                
                <div class="input-group">
                    <label>ä¸Šç‰Œï¼ˆæ˜ç‰Œï¼‰</label>
                    <select id="top-card"></select>
                </div>

                <div class="input-group">
                    <label>ä¸‹ç‰Œï¼ˆæš—ç‰Œï¼‰</label>
                    <select id="bottom-card"></select>
                </div>

                <div class="card">
                    <strong>å½“å‰é˜µè¥ï¼š</strong>
                    <span id="current-camp"></span>
                </div>

                <button class="btn btn-success" onclick="confirmSelection()">
                    âœ… ç¡®è®¤é€‰æ‹©
                </button>
            </div>

            <div id="confirmed-area" style="display: none;">
                <div class="alert alert-success">
                    <strong>âœ… å·²ç¡®è®¤ï¼</strong><br>
                    ä½ çš„é€‰æ‹©å·²ä¿å­˜åˆ°äº‘ç«¯ã€‚<br>
                    ç­‰å¾…æ³•å®˜å¼€å§‹æ¸¸æˆ...
                </div>
            </div>
        </div>
    </div>

    <script>
        // LeanCloudé…ç½®
        const LEANCLOUD_CONFIG = {
            appId: 'QS8uzJ0ZPkhrjSBlepFgow3B-gzGzoHsz',
            appKey: 'YVLqKet5nB8wcRVYWAGkUMNL',
            serverURL: 'https://qs8uzj0z.lc-cn-n1-shared.com'
        };

        // åˆå§‹åŒ–LeanCloud
        AV.init({
            appId: LEANCLOUD_CONFIG.appId,
            appKey: LEANCLOUD_CONFIG.appKey,
            serverURL: LEANCLOUD_CONFIG.serverURL
        });

        // è§’è‰²å®šä¹‰
        const ROLES = {
            wolf: { name: 'æ™®é€šç‹¼äºº', camp: 'wolf', emoji: 'ğŸº' },
            seer: { name: 'é¢„è¨€å®¶', camp: 'good', emoji: 'ğŸ”®' },
            witch: { name: 'å¥³å·«', camp: 'good', emoji: 'ğŸ§™' },
            hunter: { name: 'çŒäºº', camp: 'good', emoji: 'ğŸ¹' },
            guard: { name: 'å®ˆå«', camp: 'good', emoji: 'ğŸ›¡ï¸' },
            villager: { name: 'æ‘æ°‘', camp: 'good', emoji: 'ğŸ‘¤' }
        };

        let currentMode = null;
        let currentPlayer = {
            sessionId: null,
            number: null,
            cards: [],
            topCard: null,
            bottomCard: null
        };

        // ç”Ÿæˆéšæœºå¯†ç 
        function generatePassword() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        // ç”Ÿæˆä¼šè¯ID
        function generateSessionId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5).toUpperCase();
        }

        // é€‰æ‹©æ¨¡å¼
        function selectMode(mode) {
            currentMode = mode;
            hideAll();
            
            if (mode === 'judge') {
                document.getElementById('judge-config-section').classList.add('active');
                const sessionId = generateSessionId();
                document.getElementById('session-id').value = sessionId;
                updatePlayerUrl(sessionId);
            } else {
                document.getElementById('player-login-section').classList.add('active');
                // æ£€æŸ¥URLå‚æ•°
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('session');
                if (sessionId) {
                    document.getElementById('player-session-id').value = sessionId;
                }
            }
        }

        // æ›´æ–°ç©å®¶URL
        function updatePlayerUrl(sessionId) {
            const baseUrl = window.location.origin + window.location.pathname;
            const playerUrl = `${baseUrl}?mode=player&session=${sessionId}`;
            document.getElementById('player-url').textContent = playerUrl;
        }

        // å¤åˆ¶ä¼šè¯ID
        function copySessionId() {
            const sessionId = document.getElementById('session-id').value;
            navigator.clipboard.writeText(sessionId).then(() => {
                alert('âœ… ä¼šè¯IDå·²å¤åˆ¶ï¼');
            });
        }

        // å¤åˆ¶ç©å®¶é“¾æ¥
        function copyPlayerUrl() {
            const url = document.getElementById('player-url').textContent;
            navigator.clipboard.writeText(url).then(() => {
                alert('âœ… ç©å®¶é“¾æ¥å·²å¤åˆ¶ï¼å‘ç»™ç©å®¶å³å¯ã€‚');
            });
        }

        // ç”Ÿæˆæ¸¸æˆ
        async function generateGame() {
            const playerCount = parseInt(document.getElementById('player-count').value);
            const sessionId = document.getElementById('session-id').value;

            if (!playerCount || playerCount < 6) {
                alert('âŒ ç©å®¶äººæ•°è‡³å°‘6äººï¼');
                return;
            }

            // ç®€åŒ–é…ç½®ï¼šå›ºå®šè§’è‰²
            const roles = ['wolf', 'wolf', 'seer', 'witch', 'hunter', 'guard'];
            // ä¿®å¤ï¼šéœ€è¦ playerCount * 2 å¼ ç‰Œï¼ˆæ¯äºº2å¼ ï¼‰
            while (roles.length < playerCount * 2) {
                roles.push('villager');
            }

            // éšæœºæ‰“ä¹±
            for (let i = roles.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [roles[i], roles[j]] = [roles[j], roles[i]];
            }

            // åˆ†é…èº«ä»½ï¼ˆæ¯äºº2å¼ ï¼‰
            const distributions = {};
            const passwords = {};
            
            for (let i = 1; i <= playerCount; i++) {
                const idx1 = (i - 1) * 2;
                const idx2 = idx1 + 1;
                
                distributions[i] = {
                    cards: [roles[idx1], roles[idx2]]
                };
                
                passwords[i] = generatePassword();
            }

            // ä¿å­˜åˆ°äº‘ç«¯
            const GameSession = AV.Object.extend('GameSession');
            const gameSession = new GameSession();
            
            gameSession.set('sessionId', sessionId);
            gameSession.set('data', {
                sessionId: sessionId,
                playerCount: playerCount,
                distributions: distributions,
                passwords: passwords,
                selections: {},
                timestamp: Date.now()
            });

            try {
                await gameSession.save();
                console.log('âœ… æ¸¸æˆæ•°æ®å·²ä¿å­˜åˆ°äº‘ç«¯');
                
                // æ˜¾ç¤ºå¯†ç 
                let passwordHtml = '<table><tr><th>å·ç </th><th>å¯†ç </th><th>èº«ä»½</th></tr>';
                for (let i = 1; i <= playerCount; i++) {
                    const cards = distributions[i].cards.map(r => ROLES[r].emoji + ROLES[r].name).join('ã€');
                    passwordHtml += `<tr><td>${i}å·</td><td><strong>${passwords[i]}</strong></td><td>${cards}</td></tr>`;
                }
                passwordHtml += '</table>';
                
                document.getElementById('passwords-list').innerHTML = passwordHtml;
                document.getElementById('passwords-section').style.display = 'block';
                document.getElementById('judge-status').style.display = 'block';
                
                alert('âœ… æ¸¸æˆç”ŸæˆæˆåŠŸï¼\n\nè¯·å°†ä¼šè¯IDå’Œé“¾æ¥åˆ†äº«ç»™ç©å®¶ã€‚\nç‚¹å‡»"æŸ¥çœ‹å¯†ç "å‘Šè¯‰æ¯ä¸ªç©å®¶ä»–ä»¬çš„å¯†ç ã€‚');
                
                refreshStatus();
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        }

        // åˆ·æ–°çŠ¶æ€
        async function refreshStatus() {
            const sessionId = document.getElementById('session-id').value;
            
            try {
                const query = new AV.Query('GameSession');
                query.equalTo('sessionId', sessionId);
                const result = await query.first();
                
                if (!result) {
                    alert('âŒ æœªæ‰¾åˆ°æ¸¸æˆä¼šè¯ï¼');
                    return;
                }
                
                const data = result.get('data');
                const selections = data.selections || {};
                const playerCount = data.playerCount;
                
                let html = '<table><tr><th>å·ç </th><th>çŠ¶æ€</th><th>é€‰æ‹©</th></tr>';
                let confirmed = 0;
                
                for (let i = 1; i <= playerCount; i++) {
                    const selection = selections[i];
                    const status = selection && selection.confirmed ? 'âœ… å·²å®Œæˆ' : 'â³ ç­‰å¾…ä¸­';
                    const choice = selection && selection.confirmed ? 
                        `ä¸Šï¼š${ROLES[selection.top].name}ï¼Œä¸‹ï¼š${ROLES[selection.bottom].name}` : '-';
                    
                    html += `<tr><td>${i}å·</td><td>${status}</td><td>${choice}</td></tr>`;
                    
                    if (selection && selection.confirmed) confirmed++;
                }
                
                html += '</table>';
                html += `<p><strong>è¿›åº¦ï¼š${confirmed}/${playerCount}</strong></p>`;
                
                if (confirmed === playerCount) {
                    html += '<div class="alert alert-success"><strong>âœ… æ‰€æœ‰ç©å®¶å·²å®Œæˆé€‰æ‹©ï¼å¯ä»¥å¼€å§‹æ¸¸æˆäº†ï¼</strong></div>';
                }
                
                document.getElementById('status-table').innerHTML = html;
            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
                alert('âŒ åˆ·æ–°å¤±è´¥ï¼š' + error.message);
            }
        }

        // ç©å®¶ç™»å½•
        async function playerLogin() {
            const sessionId = document.getElementById('player-session-id').value.trim();
            const number = parseInt(document.getElementById('player-number').value);
            const password = document.getElementById('player-password').value.trim();

            if (!sessionId) {
                alert('âŒ è¯·è¾“å…¥ä¼šè¯IDï¼');
                return;
            }

            if (!number || number < 1) {
                alert('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„å·ç ï¼');
                return;
            }

            if (!password || password.length !== 4) {
                alert('âŒ è¯·è¾“å…¥4ä½å¯†ç ï¼');
                return;
            }

            try {
                const query = new AV.Query('GameSession');
                query.equalTo('sessionId', sessionId);
                const result = await query.first();

                if (!result) {
                    alert('âŒ ä¼šè¯IDä¸å­˜åœ¨ï¼\nè¯·æ£€æŸ¥æ˜¯å¦è¾“å…¥æ­£ç¡®ã€‚');
                    return;
                }

                const data = result.get('data');
                
                // éªŒè¯å·ç å’Œå¯†ç 
                if (!data.passwords[number]) {
                    alert('âŒ å·ç ä¸å­˜åœ¨ï¼');
                    return;
                }

                if (data.passwords[number] !== password) {
                    alert('âŒ å¯†ç é”™è¯¯ï¼\nè¯·é‡æ–°è¾“å…¥ã€‚');
                    return;
                }

                // ç™»å½•æˆåŠŸ
                currentPlayer.sessionId = sessionId;
                currentPlayer.number = number;
                currentPlayer.cards = data.distributions[number].cards;
                currentPlayer.gameData = data;
                currentPlayer.gameObject = result;

                showPlayerSelection();
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                alert('âŒ ç™»å½•å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ˜¾ç¤ºç©å®¶é€‰æ‹©ç•Œé¢
        function showPlayerSelection() {
            hideAll();
            document.getElementById('player-selection-section').classList.add('active');

            // æ˜¾ç¤ºç‰Œ
            const cards = currentPlayer.cards;
            let html = '<div class="alert alert-info"><h3>ä½ åˆ†åˆ°çš„ç‰Œï¼š</h3>';
            cards.forEach(roleId => {
                const role = ROLES[roleId];
                const campClass = role.camp === 'wolf' ? 'wolf' : 'good';
                html += `<div class="role-card ${campClass}">${role.emoji} ${role.name}</div>`;
            });
            html += '</div>';
            document.getElementById('player-cards').innerHTML = html;

            // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©
            const selection = currentPlayer.gameData.selections[currentPlayer.number];
            if (selection && selection.confirmed) {
                document.getElementById('selection-area').style.display = 'none';
                document.getElementById('confirmed-area').style.display = 'block';
                return;
            }

            // å¡«å……ä¸‹æ‹‰æ¡†
            const topSelect = document.getElementById('top-card');
            const bottomSelect = document.getElementById('bottom-card');
            
            topSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            bottomSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            
            cards.forEach(roleId => {
                const role = ROLES[roleId];
                topSelect.innerHTML += `<option value="${roleId}">${role.emoji} ${role.name}</option>`;
                bottomSelect.innerHTML += `<option value="${roleId}">${role.emoji} ${role.name}</option>`;
            });

            // ç›‘å¬é€‰æ‹©å˜åŒ–
            topSelect.onchange = updateCamp;
            bottomSelect.onchange = updateCamp;
        }

        // æ›´æ–°é˜µè¥æ˜¾ç¤º
        function updateCamp() {
            const topCard = document.getElementById('top-card').value;
            const bottomCard = document.getElementById('bottom-card').value;

            if (!topCard || !bottomCard) {
                document.getElementById('current-camp').textContent = '-';
                return;
            }

            const topRole = ROLES[topCard];
            const topCamp = topRole.camp === 'wolf' ? 'ç‹¼äººé˜µè¥ ğŸº' : 'å¥½äººé˜µè¥ ğŸ‘¥';
            
            document.getElementById('current-camp').innerHTML = `<span class="role-card ${topRole.camp === 'wolf' ? 'wolf' : 'good'}">${topCamp}</span>`;
        }

        // ç¡®è®¤é€‰æ‹©
        async function confirmSelection() {
            const topCard = document.getElementById('top-card').value;
            const bottomCard = document.getElementById('bottom-card').value;

            if (!topCard || !bottomCard) {
                alert('âŒ è¯·é€‰æ‹©ä¸Šç‰Œå’Œä¸‹ç‰Œï¼');
                return;
            }

            if (topCard === bottomCard) {
                alert('âŒ ä¸Šç‰Œå’Œä¸‹ç‰Œä¸èƒ½ç›¸åŒï¼');
                return;
            }

            const topRole = ROLES[topCard];
            const bottomRole = ROLES[bottomCard];
            
            if (!confirm(`ç¡®è®¤ä½ çš„é€‰æ‹©ï¼Ÿ\n\nä¸Šç‰Œï¼š${topRole.emoji} ${topRole.name}\nä¸‹ç‰Œï¼š${bottomRole.emoji} ${bottomRole.name}\n\nç¡®è®¤åæ— æ³•ä¿®æ”¹ï¼`)) {
                return;
            }

            // æ›´æ–°äº‘ç«¯æ•°æ®
            try {
                const data = currentPlayer.gameData;
                data.selections[currentPlayer.number] = {
                    top: topCard,
                    bottom: bottomCard,
                    confirmed: true
                };
                
                currentPlayer.gameObject.set('data', data);
                await currentPlayer.gameObject.save();

                document.getElementById('selection-area').style.display = 'none';
                document.getElementById('confirmed-area').style.display = 'block';
                
                alert('âœ… é€‰æ‹©å·²ä¿å­˜ï¼\nç­‰å¾…æ³•å®˜å¼€å§‹æ¸¸æˆ...');
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        }

        // ç©å®¶ç™»å‡º
        function playerLogout() {
            currentPlayer = {
                sessionId: null,
                number: null,
                cards: [],
                topCard: null,
                bottomCard: null
            };
            goHome();
        }

        // è¿”å›é¦–é¡µ
        function goHome() {
            hideAll();
            document.getElementById('home-section').classList.add('active');
        }

        // éšè—æ‰€æœ‰section
        function hideAll() {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥URLå‚æ•°
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            
            if (mode === 'player') {
                selectMode('player');
            } else if (mode === 'judge') {
                selectMode('judge');
            }
            
            console.log('âœ… LeanCloudå·²åˆå§‹åŒ–');
        });
    </script>
</body>
</html>
