<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒèº«ä»½ç‹¼äººæ€ - å®Œæ•´äº‘ç«¯ç‰ˆ</title>
    
    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av-min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* æ¨¡å¼é€‰æ‹©é¡µé¢ */
        .mode-select {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 600px;
            margin: 100px auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .mode-select h1 {
            margin-bottom: 20px;
            color: #333;
        }

        .mode-buttons {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            justify-content: center;
        }

        .mode-btn {
            flex: 1;
            padding: 30px;
            font-size: 20px;
            font-weight: bold;
            border: 3px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .mode-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .mode-btn.judge {
            border-color: #3498db;
            color: #3498db;
        }

        .mode-btn.judge:hover {
            background: #3498db;
            color: white;
        }

        .mode-btn.player {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .mode-btn.player:hover {
            background: #e74c3c;
            color: white;
        }

        /* é€šç”¨æ ·å¼ */
        .hidden {
            display: none !important;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1, h2, h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .input-group input, 
        .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #0c5460;
            color: #0c5460;
        }

        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        /* è§’è‰²é€‰æ‹© */
        .role-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .role-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .role-item.selected {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .role-info {
            flex: 1;
        }

        .role-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .role-desc {
            font-size: 12px;
            color: #666;
        }

        .role-counter {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .role-counter button {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 4px;
            background: #3498db;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }

        .role-counter span {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }

        .count-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 18px;
        }

        .count-info div {
            margin: 10px 0;
        }

        #count-status {
            font-weight: bold;
            font-size: 20px;
        }

        #count-status.valid {
            color: #27ae60;
        }

        #count-status.invalid {
            color: #e74c3c;
        }

        /* ç©å®¶å¡ç‰‡ */
        .player-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .player-card {
            background: #f8f9fa;
            border: 3px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
        }

        .player-card h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .player-card select {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
        }

        .player-card .camp-display {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        .player-card .camp-wolf {
            background: #ffe6e6;
            color: #e74c3c;
        }

        .player-card .camp-good {
            background: #e3f2fd;
            color: #3498db;
        }

        /* ç©å®¶çŠ¶æ€è¡¨æ ¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        table th, table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .role-badge {
            display: inline-block;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 14px;
        }

        .role-badge.wolf {
            background: #e74c3c;
            color: white;
        }

        .role-badge.good {
            background: #27ae60;
            color: white;
        }

        /* ç©å®¶ç«¯æ ·å¼ */
        .player-view {
            max-width: 600px;
            margin: 0 auto;
        }

        .card-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 3px solid #3498db;
        }

        .card-display h3 {
            text-align: center;
            margin-bottom: 15px;
        }

        .cards-grid {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .card-item {
            flex: 1;
            padding: 30px;
            background: white;
            border-radius: 10px;
            text-align: center;
            border: 3px solid #ddd;
        }

        .card-item.wolf {
            border-color: #e74c3c;
            background: #ffe6e6;
        }

        .card-item.good {
            border-color: #27ae60;
            background: #e8f5e9;
        }

        .card-emoji {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .card-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .card-camp {
            font-size: 14px;
            color: #666;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: white;
            border: 2px solid #3498db;
            color: #3498db;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            z-index: 1000;
        }

        .back-btn:hover {
            background: #3498db;
            color: white;
        }

        .share-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }

        .share-url {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            word-break: break-all;
            border: 2px dashed #3498db;
            font-family: monospace;
        }

        .copy-btn {
            background: #27ae60;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .copy-btn:hover {
            background: #229954;
        }

        @media (max-width: 768px) {
            .role-selection {
                grid-template-columns: 1fr;
            }

            .player-cards {
                grid-template-columns: 1fr;
            }

            .mode-buttons {
                flex-direction: column;
            }

            .cards-grid {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <!-- æ¨¡å¼é€‰æ‹©é¡µ -->
        <div id="mode-select-page" class="mode-select">
            <h1>ğŸ® åŒèº«ä»½ç‹¼äººæ€</h1>
            <p style="color: #666; margin: 10px 0;">å®Œæ•´äº‘ç«¯ç‰ˆ - æ‰€æœ‰åŠŸèƒ½</p>
            <div class="alert alert-info" style="text-align: left; margin-top: 20px;">
                <strong>âœ¨ å®Œæ•´åŠŸèƒ½ç‰ˆæœ¬</strong><br>
                â€¢ è‡ªå®šä¹‰è§’è‰²é…ç½®<br>
                â€¢ æ‰‹åŠ¨/è‡ªåŠ¨å‘ç‰Œ<br>
                â€¢ å®Œæ•´æ¸¸æˆæµç¨‹<br>
                â€¢ äº‘ç«¯æ•°æ®åŒæ­¥
            </div>
            <div class="mode-buttons">
                <button class="mode-btn judge" onclick="selectMode('judge')">
                    ğŸ¯<br>æˆ‘æ˜¯æ³•å®˜
                </button>
                <button class="mode-btn player" onclick="selectMode('player')">
                    ğŸ®<br>æˆ‘æ˜¯ç©å®¶
                </button>
            </div>
        </div>

        <!-- æ³•å®˜ç«¯ -->
        <div id="judge-page" class="hidden">
            <button class="back-btn" onclick="backToModeSelect()">â† è¿”å›</button>
            
            <!-- æ­¥éª¤1: é…ç½®æ¸¸æˆ -->
            <div id="judge-config-section" class="section">
                <h1>ğŸ¯ æ³•å®˜é…ç½®æ¸¸æˆ</h1>
                
                <!-- é…ç½®æ¨¡å¼ -->
                <div class="input-group" style="background:#f8f9fa;padding:15px;border-radius:8px;">
                    <h3>ğŸ“‹ é…ç½®æ¨¡å¼</h3>
                    <label style="display:block;margin:10px 0;">
                        <input type="radio" name="config-mode" value="manual" checked onchange="updateConfigMode()">
                        <strong>æ‰‹åŠ¨é…ç½®</strong> - æ³•å®˜æ‰‹åŠ¨ä¸ºæ¯ä¸ªç©å®¶åˆ†é…ä¸Šä¸‹ç‰Œ
                    </label>
                    <label style="display:block;">
                        <input type="radio" name="config-mode" value="auto" onchange="updateConfigMode()">
                        <strong>è‡ªåŠ¨å‘ç‰Œ</strong> - ç³»ç»Ÿéšæœºåˆ†é…è§’è‰²ï¼Œç©å®¶è‡ªå·±é€‰æ‹©ä¸Šä¸‹ç‰Œ
                    </label>
                </div>

                <!-- ç©å®¶äººæ•° -->
                <div class="input-group">
                    <label for="player-count">ç©å®¶äººæ•°ï¼š</label>
                    <input type="number" id="player-count" min="6" max="20" value="10" onchange="updateRequiredCount()">
                </div>

                <!-- æ¸¸æˆä¼šè¯IDï¼ˆè‡ªåŠ¨å‘ç‰Œæ¨¡å¼ï¼‰ -->
                <div id="session-id-section" class="hidden">
                    <div class="input-group">
                        <label>æ¸¸æˆä¼šè¯IDï¼ˆåˆ†äº«ç»™ç©å®¶ï¼‰ï¼š</label>
                        <input type="text" id="session-id" readonly>
                        <button class="copy-btn" onclick="copySessionId()">ğŸ“‹ å¤åˆ¶</button>
                    </div>
                </div>

                <!-- è§’è‰²é€‰æ‹© -->
                <h2>é€‰æ‹©æœ¬å±€å¯ç”¨çš„è§’è‰²</h2>
                
                <h3>ğŸº ç‹¼äººé˜µè¥</h3>
                <div class="role-selection" id="wolf-roles"></div>

                <h3>ğŸ›¡ï¸ ç¥èŒè§’è‰²</h3>
                <div class="role-selection" id="god-roles"></div>

                <h3>ğŸ‘¥ å¹³æ°‘</h3>
                <div class="role-selection" id="villager-roles"></div>

                <!-- è®¡æ•°ä¿¡æ¯ -->
                <div class="count-info">
                    <div>å·²é€‰è§’è‰²æ•°ï¼š<span id="selected-count">0</span></div>
                    <div>éœ€è¦è§’è‰²æ•°ï¼š<span id="required-count">0</span>ï¼ˆç©å®¶æ•° Ã— 2ï¼‰</div>
                    <div id="count-status"></div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="btn-group">
                    <button class="btn btn-primary" id="start-assign-btn" onclick="startAssign()" disabled>
                        å¼€å§‹åˆ†é…èº«ä»½
                    </button>
                </div>
            </div>

            <!-- æ­¥éª¤2: èº«ä»½åˆ†é…ï¼ˆæ‰‹åŠ¨æ¨¡å¼ï¼‰æˆ– ç”Ÿæˆå‘ç‰Œï¼ˆè‡ªåŠ¨æ¨¡å¼ï¼‰ -->
            <div id="judge-assign-section" class="section hidden">
                <h1>ğŸ­ èº«ä»½åˆ†é…</h1>
                
                <!-- æ‰‹åŠ¨æ¨¡å¼ -->
                <div id="manual-assign-area">
                    <div class="alert alert-info">
                        ä¸ºæ¯ä¸ªç©å®¶åˆ†é…ä¸Šç‰Œï¼ˆç¬¬ä¸€èº«ä»½ï¼‰å’Œä¸‹ç‰Œï¼ˆç¬¬äºŒèº«ä»½ï¼‰
                    </div>
                    <div class="player-cards" id="player-cards"></div>
                </div>

                <!-- è‡ªåŠ¨æ¨¡å¼ -->
                <div id="auto-assign-area" class="hidden">
                    <div class="alert alert-success">
                        âœ… æ¸¸æˆå·²ç”Ÿæˆï¼å¯†ç å·²è‡ªåŠ¨ç”Ÿæˆã€‚
                    </div>

                    <div class="share-section">
                        <h3>ğŸ“± ç©å®¶è®¿é—®åœ°å€</h3>
                        <div class="share-url" id="player-url"></div>
                        <button class="copy-btn" onclick="copyPlayerUrl()">ğŸ“‹ å¤åˆ¶é“¾æ¥</button>
                    </div>

                    <div class="alert alert-warning">
                        <h3>ğŸ”‘ ç©å®¶å¯†ç åˆ—è¡¨</h3>
                        <div id="passwords-list"></div>
                    </div>

                    <div id="player-status-section">
                        <h3>ğŸ“Š ç©å®¶é€‰æ‹©çŠ¶æ€</h3>
                        <div id="status-table"></div>
                        <button class="btn btn-primary" onclick="refreshPlayerStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
                    </div>

                    <!-- æ³•å®˜æ‰‹åŠ¨è®¾ç½®åŒºåŸŸ -->
                    <div style="margin-top: 30px; border-top: 2px solid #ddd; padding-top: 20px;">
                        <h3>âš™ï¸ æ³•å®˜æ‰‹åŠ¨è®¾ç½®ï¼ˆç©å®¶æ— æ³•æ“ä½œæ—¶ä½¿ç”¨ï¼‰</h3>
                        <div class="alert alert-info">
                            å¦‚æœæŸäº›ç©å®¶æ— æ³•ä½¿ç”¨æ‰‹æœºæˆ–æ“ä½œæœ‰å›°éš¾ï¼Œæ³•å®˜å¯ä»¥åœ¨è¿™é‡Œç›´æ¥ä¸ºä»–ä»¬è®¾ç½®èº«ä»½ã€‚
                        </div>
                        <div id="manual-setup-area"></div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="backToConfig()">â† è¿”å›é…ç½®</button>
                    <button class="btn btn-primary" onclick="startGame()">å¼€å§‹æ¸¸æˆ â†’</button>
                </div>
            </div>

            <!-- æ­¥éª¤3: æ¸¸æˆè¿›è¡Œä¸­ -->
            <div id="judge-game-section" class="section hidden">
                <h1>ğŸ® æ¸¸æˆè¿›è¡Œä¸­</h1>
                <div class="alert alert-info">
                    æ¸¸æˆç®¡ç†åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...
                    <br>å½“å‰å·²å®Œæˆï¼šè§’è‰²é…ç½®ã€èº«ä»½åˆ†é…ã€å¯†ç éªŒè¯ã€è·¨è®¾å¤‡åŒæ­¥
                </div>
                <button class="btn btn-danger" onclick="restartGame()">é‡æ–°å¼€å§‹æ¸¸æˆ</button>
            </div>
        </div>

        <!-- ç©å®¶ç«¯ -->
        <div id="player-page" class="hidden player-view">
            <button class="back-btn" onclick="backToModeSelect()">â† è¿”å›</button>
            
            <!-- ç©å®¶ç™»å½• -->
            <div id="player-login-section" class="section">
                <h1>ğŸ® ç©å®¶ç™»å½•</h1>
                
                <div class="alert alert-info">
                    <strong>è¯´æ˜ï¼š</strong><br>
                    1. è¾“å…¥æ³•å®˜ç»™ä½ çš„ä¼šè¯ID<br>
                    2. è¾“å…¥ä½ çš„å·ç å’Œå¯†ç <br>
                    3. æŸ¥çœ‹å¹¶é€‰æ‹©ä½ çš„èº«ä»½ç‰Œ
                </div>

                <div class="input-group">
                    <label>æ¸¸æˆä¼šè¯ID</label>
                    <input type="text" id="player-session-id" placeholder="è¾“å…¥æ³•å®˜ç»™ä½ çš„ä¼šè¯ID">
                </div>

                <div class="input-group">
                    <label>ä½ çš„å·ç </label>
                    <input type="number" id="player-number" min="1" max="20" placeholder="è¾“å…¥å·ç ï¼ˆå¦‚ï¼š1ï¼‰">
                </div>

                <div class="input-group">
                    <label>å¯†ç </label>
                    <input type="text" id="player-password" maxlength="4" placeholder="è¾“å…¥4ä½å¯†ç ">
                </div>

                <button class="btn btn-success" style="width: 100%;" onclick="playerLogin()">
                    ğŸ´ æŸ¥çœ‹æˆ‘çš„èº«ä»½
                </button>
            </div>

            <!-- ç©å®¶é€‰æ‹© -->
            <div id="player-selection-section" class="section hidden">
                <h1>ğŸ­ ä½ çš„èº«ä»½ç‰Œ</h1>
                
                <div class="alert alert-warning">
                    <strong>âš ï¸ è¯·ä¿å¯†ï¼</strong>ä¸è¦è®©å…¶ä»–ç©å®¶çœ‹åˆ°ä½ çš„å±å¹•ï¼
                </div>

                <div id="player-cards-display"></div>

                <div id="selection-area">
                    <h3 style="margin-top: 30px;">é€‰æ‹©ä½ çš„ä¸Šç‰Œå’Œä¸‹ç‰Œï¼š</h3>
                    
                    <div class="input-group">
                        <label>ä¸Šç‰Œï¼ˆæ˜ç‰Œï¼‰</label>
                        <select id="player-top-card" onchange="updatePlayerCamp()"></select>
                    </div>

                    <div class="input-group">
                        <label>ä¸‹ç‰Œï¼ˆæš—ç‰Œï¼‰</label>
                        <select id="player-bottom-card" onchange="updatePlayerCamp()"></select>
                    </div>

                    <div class="card-display">
                        <strong>å½“å‰é˜µè¥ï¼š</strong>
                        <span id="current-camp" style="font-size: 24px; font-weight: bold;"></span>
                    </div>

                    <button class="btn btn-success" style="width: 100%;" onclick="confirmPlayerSelection()">
                        âœ… ç¡®è®¤é€‰æ‹©
                    </button>
                </div>

                <div id="confirmed-area" class="hidden">
                    <div class="alert alert-success">
                        <strong>âœ… å·²ç¡®è®¤ï¼</strong><br>
                        ä½ çš„é€‰æ‹©å·²ä¿å­˜åˆ°äº‘ç«¯ã€‚<br>
                        ç­‰å¾…æ³•å®˜å¼€å§‹æ¸¸æˆ...
                    </div>
                    <button class="btn btn-secondary" onclick="playerLogout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== å…¨å±€é…ç½® ====================
        
        // LeanCloudé…ç½®
        const LEANCLOUD_CONFIG = {
            appId: 'QS8uzJ0ZPkhrjSBlepFgow3B-gzGzoHsz',
            appKey: 'YVLqKet5nB8wcRVYWAGkUMNL',
            serverURL: 'https://qs8uzj0z.lc-cn-n1-shared.com'
        };

        // åˆå§‹åŒ–LeanCloud
        AV.init({
            appId: LEANCLOUD_CONFIG.appId,
            appKey: LEANCLOUD_CONFIG.appKey,
            serverURL: LEANCLOUD_CONFIG.serverURL
        });

        console.log('âœ… LeanCloudå·²åˆå§‹åŒ–');

        // è§’è‰²å®šä¹‰
        const ROLES = {
            // ç‹¼äººé˜µè¥
            wolf: { name: 'æ™®é€šç‹¼äºº', camp: 'wolf', desc: 'å¤œæ™šççœ¼åˆ€äºº', emoji: 'ğŸº' },
            wolfKing: { name: 'ç‹¼ç‹', camp: 'wolf', desc: 'å¯è‡ªçˆ†å¸¦äºº', emoji: 'ğŸ‘‘' },
            hiddenWolf: { name: 'éšç‹¼', camp: 'wolf', desc: 'é¢„è¨€å®¶éªŒä¸å‡º', emoji: 'ğŸŒ™' },
            wolfBeauty: { name: 'ç‹¼ç¾äºº', camp: 'wolf', desc: 'æ¯æ™šé­…æƒ‘ä¸€äºº', emoji: 'ğŸ’ƒ' },
            
            // ç¥èŒ
            seer: { name: 'é¢„è¨€å®¶', camp: 'good', desc: 'æ¯æ™šéªŒä¸€äººèº«ä»½', emoji: 'ğŸ”®' },
            witch: { name: 'å¥³å·«', camp: 'good', desc: 'è§£è¯+æ¯’è¯å„ä¸€ç“¶', emoji: 'ğŸ§™' },
            hunter: { name: 'çŒäºº', camp: 'good', desc: 'æ­»äº¡å¼€æªå¸¦äºº', emoji: 'ğŸ¹' },
            guard: { name: 'å®ˆå«', camp: 'good', desc: 'æ¯æ™šå®ˆæŠ¤ä¸€äºº', emoji: 'ğŸ›¡ï¸' },
            cupid: { name: 'ä¸˜æ¯”ç‰¹', camp: 'good', desc: 'ç¬¬ä¸€å¤œè¿æ¥æƒ…ä¾£', emoji: 'ğŸ’˜' },
            thief: { name: 'ç›—è´¼', camp: 'good', desc: 'ç¬¬ä¸€å¤œæŸ¥çœ‹åº•ç‰Œ', emoji: 'ğŸ­' },
            wildChild: { name: 'é‡å­©å­', camp: 'good', desc: 'é€‰æ¦œæ ·ï¼Œæ¦œæ ·æ­»åå˜ç‹¼', emoji: 'ğŸ¦Š' },
            
            // å¹³æ°‘
            villager: { name: 'æ™®é€šæ‘æ°‘', camp: 'good', desc: 'æ— ç‰¹æ®ŠæŠ€èƒ½', emoji: 'ğŸ‘¤' }
        };

        // å…¨å±€çŠ¶æ€
        let currentMode = null; // 'judge' or 'player'
        let judgeState = {
            configMode: 'manual', // 'manual' or 'auto'
            playerCount: 10,
            selectedRoles: {},
            distributions: {},
            passwords: {},
            sessionId: null,
            gameObject: null
        };

        let playerState = {
            sessionId: null,
            playerNumber: null,
            cards: [],
            topCard: null,
            bottomCard: null,
            confirmed: false
        };

        // ==================== æ¨¡å¼é€‰æ‹© ====================
        
        function selectMode(mode) {
            currentMode = mode;
            
            document.getElementById('mode-select-page').classList.add('hidden');
            
            if (mode === 'judge') {
                document.getElementById('judge-page').classList.remove('hidden');
                initJudgeMode();
            } else {
                document.getElementById('player-page').classList.remove('hidden');
                initPlayerMode();
            }
        }

        function backToModeSelect() {
            document.getElementById('mode-select-page').classList.remove('hidden');
            document.getElementById('judge-page').classList.add('hidden');
            document.getElementById('player-page').classList.add('hidden');
            currentMode = null;
        }

        // ==================== æ³•å®˜æ¨¡å¼ ====================
        
        function initJudgeMode() {
            // ç”Ÿæˆä¼šè¯ID
            judgeState.sessionId = generateSessionId();
            document.getElementById('session-id').value = judgeState.sessionId;
            
            // æ¸²æŸ“è§’è‰²é€‰æ‹©
            renderRoleSelection();
            updateRequiredCount();
        }

        function generateSessionId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5).toUpperCase();
        }

        function generatePassword() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        function renderRoleSelection() {
            // ç‹¼äººé˜µè¥
            const wolfRoles = ['wolf', 'wolfKing', 'hiddenWolf', 'wolfBeauty'];
            document.getElementById('wolf-roles').innerHTML = wolfRoles.map(id => createRoleItem(id)).join('');
            
            // ç¥èŒ
            const godRoles = ['seer', 'witch', 'hunter', 'guard', 'cupid', 'thief', 'wildChild'];
            document.getElementById('god-roles').innerHTML = godRoles.map(id => createRoleItem(id)).join('');
            
            // æ‘æ°‘
            document.getElementById('villager-roles').innerHTML = createRoleItem('villager');
            
            // åˆå§‹åŒ–é»˜è®¤é…ç½®ï¼ˆ10äººå±€ï¼‰
            judgeState.selectedRoles = {
                wolf: 2,
                seer: 1,
                witch: 1,
                hunter: 1,
                guard: 1,
                villager: 14
            };
            
            updateRoleDisplay();
        }

        function createRoleItem(roleId) {
            const role = ROLES[roleId];
            return `
                <div class="role-item" id="role-${roleId}">
                    <div class="role-info">
                        <div class="role-name">${role.emoji} ${role.name}</div>
                        <div class="role-desc">${role.desc}</div>
                    </div>
                    <div class="role-counter">
                        <button onclick="changeRoleCount('${roleId}', -1)">âˆ’</button>
                        <span id="count-${roleId}">0</span>
                        <button onclick="changeRoleCount('${roleId}', 1)">+</button>
                    </div>
                </div>
            `;
        }

        function changeRoleCount(roleId, delta) {
            const current = judgeState.selectedRoles[roleId] || 0;
            const newCount = Math.max(0, current + delta);
            judgeState.selectedRoles[roleId] = newCount;
            updateRoleDisplay();
        }

        function updateRoleDisplay() {
            Object.keys(judgeState.selectedRoles).forEach(roleId => {
                const countEl = document.getElementById(`count-${roleId}`);
                if (countEl) {
                    countEl.textContent = judgeState.selectedRoles[roleId];
                }
                
                const roleItem = document.getElementById(`role-${roleId}`);
                if (roleItem) {
                    if (judgeState.selectedRoles[roleId] > 0) {
                        roleItem.classList.add('selected');
                    } else {
                        roleItem.classList.remove('selected');
                    }
                }
            });
            
            updateCountStatus();
        }

        function updateRequiredCount() {
            judgeState.playerCount = parseInt(document.getElementById('player-count').value) || 10;
            const required = judgeState.playerCount * 2;
            document.getElementById('required-count').textContent = required;
            updateCountStatus();
        }

        function updateCountStatus() {
            let total = 0;
            Object.values(judgeState.selectedRoles).forEach(count => {
                total += count;
            });
            
            document.getElementById('selected-count').textContent = total;
            
            const required = judgeState.playerCount * 2;
            const statusEl = document.getElementById('count-status');
            const startBtn = document.getElementById('start-assign-btn');
            
            if (total === required) {
                statusEl.textContent = 'âœ… è§’è‰²æ•°é‡æ­£ç¡®ï¼';
                statusEl.className = 'valid';
                startBtn.disabled = false;
            } else if (total < required) {
                statusEl.textContent = `âŒ è¿˜éœ€${required - total}å¼ ç‰Œ`;
                statusEl.className = 'invalid';
                startBtn.disabled = true;
            } else {
                statusEl.textContent = `âŒ å¤šäº†${total - required}å¼ ç‰Œ`;
                statusEl.className = 'invalid';
                startBtn.disabled = true;
            }
        }

        function updateConfigMode() {
            const mode = document.querySelector('input[name="config-mode"]:checked').value;
            judgeState.configMode = mode;
            
            if (mode === 'auto') {
                document.getElementById('session-id-section').classList.remove('hidden');
                updatePlayerUrl();
            } else {
                document.getElementById('session-id-section').classList.add('hidden');
            }
        }

        function updatePlayerUrl() {
            const baseUrl = window.location.origin + window.location.pathname;
            const playerUrl = `${baseUrl}?mode=player&session=${judgeState.sessionId}`;
            document.getElementById('player-url').textContent = playerUrl;
        }

        function copySessionId() {
            navigator.clipboard.writeText(judgeState.sessionId).then(() => {
                alert('âœ… ä¼šè¯IDå·²å¤åˆ¶ï¼');
            });
        }

        function copyPlayerUrl() {
            const url = document.getElementById('player-url').textContent;
            navigator.clipboard.writeText(url).then(() => {
                alert('âœ… ç©å®¶é“¾æ¥å·²å¤åˆ¶ï¼å‘ç»™ç©å®¶å³å¯ã€‚');
            });
        }

        async function startAssign() {
            // ç”Ÿæˆè§’è‰²åˆ—è¡¨
            const roles = [];
            Object.keys(judgeState.selectedRoles).forEach(roleId => {
                const count = judgeState.selectedRoles[roleId];
                for (let i = 0; i < count; i++) {
                    roles.push(roleId);
                }
            });
            
            // éšæœºæ‰“ä¹±
            for (let i = roles.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [roles[i], roles[j]] = [roles[j], roles[i]];
            }
            
            if (judgeState.configMode === 'manual') {
                // æ‰‹åŠ¨æ¨¡å¼ï¼šåˆ†é…ä½†ä¸è®¾ç½®ä¸Šä¸‹ç‰Œ
                judgeState.distributions = {};
                for (let i = 1; i <= judgeState.playerCount; i++) {
                    const idx = (i - 1) * 2;
                    judgeState.distributions[i] = {
                        cards: [roles[idx], roles[idx + 1]],
                        top: null,
                        bottom: null
                    };
                }
                
                // æ˜¾ç¤ºæ‰‹åŠ¨åˆ†é…ç•Œé¢
                document.getElementById('judge-config-section').classList.add('hidden');
                document.getElementById('judge-assign-section').classList.remove('hidden');
                document.getElementById('manual-assign-area').classList.remove('hidden');
                document.getElementById('auto-assign-area').classList.add('hidden');
                
                renderManualAssign();
            } else {
                // è‡ªåŠ¨æ¨¡å¼ï¼šç”Ÿæˆå¯†ç å¹¶ä¿å­˜åˆ°äº‘ç«¯
                judgeState.distributions = {};
                judgeState.passwords = {};
                
                for (let i = 1; i <= judgeState.playerCount; i++) {
                    const idx = (i - 1) * 2;
                    judgeState.distributions[i] = {
                        cards: [roles[idx], roles[idx + 1]]
                    };
                    judgeState.passwords[i] = generatePassword();
                }
                
                // ä¿å­˜åˆ°äº‘ç«¯
                await saveToCloud();
                
                // æ˜¾ç¤ºè‡ªåŠ¨å‘ç‰Œç•Œé¢
                document.getElementById('judge-config-section').classList.add('hidden');
                document.getElementById('judge-assign-section').classList.remove('hidden');
                document.getElementById('manual-assign-area').classList.add('hidden');
                document.getElementById('auto-assign-area').classList.remove('hidden');
                
                renderPasswordsList();
                updatePlayerUrl();
                await refreshPlayerStatus();
            }
        }

        function renderManualAssign() {
            let html = '';
            for (let i = 1; i <= judgeState.playerCount; i++) {
                const dist = judgeState.distributions[i];
                html += `
                    <div class="player-card">
                        <h3>ç©å®¶ ${i}å·</h3>
                        <div>
                            åˆ†åˆ°çš„ç‰Œï¼š
                            ${dist.cards.map(r => `<span class="role-badge ${ROLES[r].camp}">${ROLES[r].emoji} ${ROLES[r].name}</span>`).join(' ')}
                        </div>
                        <div style="margin-top: 15px;">
                            <label>ä¸Šç‰Œï¼ˆç¬¬ä¸€èº«ä»½ï¼‰</label>
                            <select id="top-${i}" onchange="updateManualCamp(${i})">
                                <option value="">è¯·é€‰æ‹©</option>
                                ${dist.cards.map(r => `<option value="${r}">${ROLES[r].emoji} ${ROLES[r].name}</option>`).join('')}
                            </select>
                        </div>
                        <div style="margin-top: 10px;">
                            <label>ä¸‹ç‰Œï¼ˆç¬¬äºŒèº«ä»½ï¼‰</label>
                            <select id="bottom-${i}" onchange="updateManualCamp(${i})">
                                <option value="">è¯·é€‰æ‹©</option>
                                ${dist.cards.map(r => `<option value="${r}">${ROLES[r].emoji} ${ROLES[r].name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="camp-display" id="camp-${i}">æœªé€‰æ‹©</div>
                    </div>
                `;
            }
            document.getElementById('player-cards').innerHTML = html;
        }

        function updateManualCamp(playerNum) {
            const topSelect = document.getElementById(`top-${playerNum}`);
            const bottomSelect = document.getElementById(`bottom-${playerNum}`);
            const campDisplay = document.getElementById(`camp-${playerNum}`);
            
            const topCard = topSelect.value;
            const bottomCard = bottomSelect.value;
            
            if (topCard && bottomCard) {
                const topRole = ROLES[topCard];
                const campClass = topRole.camp === 'wolf' ? 'camp-wolf' : 'camp-good';
                const campText = topRole.camp === 'wolf' ? 'ç‹¼äººé˜µè¥ ğŸº' : 'å¥½äººé˜µè¥ ğŸ‘¥';
                campDisplay.className = 'camp-display ' + campClass;
                campDisplay.textContent = campText;
                
                // ä¿å­˜é€‰æ‹©
                judgeState.distributions[playerNum].top = topCard;
                judgeState.distributions[playerNum].bottom = bottomCard;
            } else {
                campDisplay.className = 'camp-display';
                campDisplay.textContent = 'æœªé€‰æ‹©';
            }
        }

        async function saveToCloud() {
            const GameSession = AV.Object.extend('GameSession');
            const gameSession = new GameSession();
            
            gameSession.set('sessionId', judgeState.sessionId);
            gameSession.set('data', {
                sessionId: judgeState.sessionId,
                playerCount: judgeState.playerCount,
                distributions: judgeState.distributions,
                passwords: judgeState.passwords,
                selections: {},
                timestamp: Date.now()
            });
            
            try {
                await gameSession.save();
                judgeState.gameObject = gameSession;
                console.log('âœ… æ¸¸æˆæ•°æ®å·²ä¿å­˜åˆ°äº‘ç«¯');
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        }

        function renderPasswordsList() {
            let html = '<table><tr><th>å·ç </th><th>å¯†ç </th><th>åˆ†åˆ°çš„ç‰Œ</th></tr>';
            for (let i = 1; i <= judgeState.playerCount; i++) {
                const cards = judgeState.distributions[i].cards;
                const cardsText = cards.map(r => ROLES[r].emoji + ROLES[r].name).join('ã€');
                html += `<tr><td>${i}å·</td><td><strong style="font-size:18px;">${judgeState.passwords[i]}</strong></td><td>${cardsText}</td></tr>`;
            }
            html += '</table>';
            document.getElementById('passwords-list').innerHTML = html;
        }

        async function refreshPlayerStatus() {
            try {
                const query = new AV.Query('GameSession');
                query.equalTo('sessionId', judgeState.sessionId);
                const result = await query.first();
                
                if (!result) {
                    alert('âŒ æœªæ‰¾åˆ°æ¸¸æˆä¼šè¯ï¼');
                    return;
                }
                
                const data = result.get('data');
                const selections = data.selections || {};
                
                let html = '<table><tr><th>å·ç </th><th>çŠ¶æ€</th><th>é€‰æ‹©</th></tr>';
                let confirmed = 0;
                
                for (let i = 1; i <= judgeState.playerCount; i++) {
                    const selection = selections[i];
                    const status = selection && selection.confirmed ? 'âœ… å·²å®Œæˆ' : 'â³ ç­‰å¾…ä¸­';
                    const choice = selection && selection.confirmed ? 
                        `ä¸Šï¼š${ROLES[selection.top].name}ï¼Œä¸‹ï¼š${ROLES[selection.bottom].name}` : '-';
                    
                    html += `<tr><td>${i}å·</td><td>${status}</td><td>${choice}</td></tr>`;
                    
                    if (selection && selection.confirmed) confirmed++;
                }
                
                html += '</table>';
                html += `<p style="margin-top:15px;"><strong>è¿›åº¦ï¼š${confirmed}/${judgeState.playerCount}</strong></p>`;
                
                if (confirmed === judgeState.playerCount) {
                    html += '<div class="alert alert-success"><strong>âœ… æ‰€æœ‰ç©å®¶å·²å®Œæˆé€‰æ‹©ï¼å¯ä»¥å¼€å§‹æ¸¸æˆäº†ï¼</strong></div>';
                }
                
                document.getElementById('status-table').innerHTML = html;
                
                // æ¸²æŸ“æ³•å®˜æ‰‹åŠ¨è®¾ç½®åŒºåŸŸ
                renderManualSetup(data, result);
            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
            }
        }

        function renderManualSetup(data, gameObject) {
            const selections = data.selections || {};
            let html = '';
            
            for (let i = 1; i <= judgeState.playerCount; i++) {
                const dist = data.distributions[i];
                const selection = selections[i];
                const cards = dist.cards;
                
                html += `<div class="player-card">`;
                html += `<strong>${i}å·ç©å®¶</strong> - åˆ†åˆ°çš„ç‰Œï¼š`;
                cards.forEach(r => {
                    const role = ROLES[r];
                    html += `<span class="role-badge ${role.camp}">${role.emoji} ${role.name}</span>`;
                });
                
                if (selection && selection.confirmed) {
                    html += `<div style="margin-top:10px;color:green;">âœ… å·²é€‰æ‹©ï¼šä¸Šç‰Œ ${ROLES[selection.top].name}ï¼Œä¸‹ç‰Œ ${ROLES[selection.bottom].name}</div>`;
                } else {
                    html += `<div style="margin-top:10px;">`;
                    html += `<label>ä¸Šç‰Œï¼š</label>`;
                    html += `<select id="judge-top-${i}">`;
                    html += `<option value="">è¯·é€‰æ‹©</option>`;
                    cards.forEach(r => {
                        html += `<option value="${r}">${ROLES[r].emoji} ${ROLES[r].name}</option>`;
                    });
                    html += `</select>`;
                    
                    html += `<label>ä¸‹ç‰Œï¼š</label>`;
                    html += `<select id="judge-bottom-${i}">`;
                    html += `<option value="">è¯·é€‰æ‹©</option>`;
                    cards.forEach(r => {
                        html += `<option value="${r}">${ROLES[r].emoji} ${ROLES[r].name}</option>`;
                    });
                    html += `</select>`;
                    
                    html += `<button class="btn btn-success" onclick="judgeSetPlayer(${i})">ä¿å­˜</button>`;
                    html += `</div>`;
                }
                
                html += `</div>`;
            }
            
            document.getElementById('manual-setup-area').innerHTML = html;
            judgeState.gameObject = gameObject;
        }

        async function judgeSetPlayer(playerNum) {
            const topSelect = document.getElementById(`judge-top-${playerNum}`);
            const bottomSelect = document.getElementById(`judge-bottom-${playerNum}`);
            
            const topCard = topSelect.value;
            const bottomCard = bottomSelect.value;
            
            if (!topCard || !bottomCard) {
                alert('âŒ è¯·é€‰æ‹©ä¸Šç‰Œå’Œä¸‹ç‰Œï¼');
                return;
            }
            
            if (!confirm(`ç¡®è®¤ä¸º${playerNum}å·è®¾ç½®ï¼š\nä¸Šç‰Œï¼š${ROLES[topCard].name}\nä¸‹ç‰Œï¼š${ROLES[bottomCard].name}ï¼Ÿ`)) {
                return;
            }
            
            try {
                const data = judgeState.gameObject.get('data');
                data.selections[playerNum] = {
                    top: topCard,
                    bottom: bottomCard,
                    confirmed: true,
                    judgeSet: true
                };
                
                judgeState.gameObject.set('data', data);
                await judgeState.gameObject.save();
                
                alert('âœ… è®¾ç½®æˆåŠŸï¼');
                await refreshPlayerStatus();
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        }

        function backToConfig() {
            document.getElementById('judge-assign-section').classList.add('hidden');
            document.getElementById('judge-config-section').classList.remove('hidden');
        }

        function startGame() {
            // éªŒè¯æ‰€æœ‰ç©å®¶å·²è®¾ç½®
            if (judgeState.configMode === 'manual') {
                let allSet = true;
                for (let i = 1; i <= judgeState.playerCount; i++) {
                    const dist = judgeState.distributions[i];
                    if (!dist.top || !dist.bottom) {
                        allSet = false;
                        break;
                    }
                }
                
                if (!allSet) {
                    alert('âŒ è¯·ä¸ºæ‰€æœ‰ç©å®¶åˆ†é…ä¸Šä¸‹ç‰Œï¼');
                    return;
                }
            }
            
            // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
            document.getElementById('judge-assign-section').classList.add('hidden');
            document.getElementById('judge-game-section').classList.remove('hidden');
        }

        function restartGame() {
            if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹æ¸¸æˆå—ï¼Ÿ')) {
                document.getElementById('judge-game-section').classList.add('hidden');
                document.getElementById('judge-config-section').classList.remove('hidden');
                
                // é‡ç½®çŠ¶æ€
                judgeState = {
                    configMode: 'manual',
                    playerCount: 10,
                    selectedRoles: {},
                    distributions: {},
                    passwords: {},
                    sessionId: generateSessionId(),
                    gameObject: null
                };
                
                document.getElementById('session-id').value = judgeState.sessionId;
                initJudgeMode();
            }
        }

        // ==================== ç©å®¶æ¨¡å¼ ====================
        
        function initPlayerMode() {
            // æ£€æŸ¥URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');
            if (sessionId) {
                document.getElementById('player-session-id').value = sessionId;
            }
        }

        async function playerLogin() {
            const sessionId = document.getElementById('player-session-id').value.trim();
            const playerNumber = parseInt(document.getElementById('player-number').value);
            const password = document.getElementById('player-password').value.trim();

            if (!sessionId) {
                alert('âŒ è¯·è¾“å…¥ä¼šè¯IDï¼');
                return;
            }

            if (!playerNumber || playerNumber < 1) {
                alert('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„å·ç ï¼');
                return;
            }

            if (!password || password.length !== 4) {
                alert('âŒ è¯·è¾“å…¥4ä½å¯†ç ï¼');
                return;
            }

            try {
                const query = new AV.Query('GameSession');
                query.equalTo('sessionId', sessionId);
                const result = await query.first();

                if (!result) {
                    alert('âŒ ä¼šè¯IDä¸å­˜åœ¨ï¼\nè¯·æ£€æŸ¥æ˜¯å¦è¾“å…¥æ­£ç¡®ã€‚');
                    return;
                }

                const data = result.get('data');
                
                // éªŒè¯å·ç å’Œå¯†ç 
                if (!data.passwords[playerNumber]) {
                    alert('âŒ å·ç ä¸å­˜åœ¨ï¼');
                    return;
                }

                if (data.passwords[playerNumber] !== password) {
                    alert('âŒ å¯†ç é”™è¯¯ï¼\nè¯·é‡æ–°è¾“å…¥ã€‚');
                    return;
                }

                // ç™»å½•æˆåŠŸ
                playerState.sessionId = sessionId;
                playerState.playerNumber = playerNumber;
                playerState.cards = data.distributions[playerNumber].cards;
                playerState.gameObject = result;

                // æ£€æŸ¥æ˜¯å¦å·²ç»é€‰æ‹©è¿‡
                const selection = data.selections[playerNumber];
                if (selection && selection.confirmed) {
                    playerState.confirmed = true;
                    playerState.topCard = selection.top;
                    playerState.bottomCard = selection.bottom;
                }

                showPlayerSelection();
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                alert('âŒ ç™»å½•å¤±è´¥ï¼š' + error.message);
            }
        }

        function showPlayerSelection() {
            document.getElementById('player-login-section').classList.add('hidden');
            document.getElementById('player-selection-section').classList.remove('hidden');

            // æ˜¾ç¤ºç‰Œ
            let html = '<div class="cards-grid">';
            playerState.cards.forEach(roleId => {
                const role = ROLES[roleId];
                html += `
                    <div class="card-item ${role.camp}">
                        <div class="card-emoji">${role.emoji}</div>
                        <div class="card-name">${role.name}</div>
                        <div class="card-camp">${role.camp === 'wolf' ? 'ç‹¼äººé˜µè¥' : 'å¥½äººé˜µè¥'}</div>
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('player-cards-display').innerHTML = html;

            // æ£€æŸ¥æ˜¯å¦å·²ç¡®è®¤
            if (playerState.confirmed) {
                document.getElementById('selection-area').classList.add('hidden');
                document.getElementById('confirmed-area').classList.remove('hidden');
                return;
            }

            // å¡«å……ä¸‹æ‹‰æ¡†
            const topSelect = document.getElementById('player-top-card');
            const bottomSelect = document.getElementById('player-bottom-card');
            
            topSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            bottomSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            
            playerState.cards.forEach(roleId => {
                const role = ROLES[roleId];
                topSelect.innerHTML += `<option value="${roleId}">${role.emoji} ${role.name}</option>`;
                bottomSelect.innerHTML += `<option value="${roleId}">${role.emoji} ${role.name}</option>`;
            });
        }

        function updatePlayerCamp() {
            const topCard = document.getElementById('player-top-card').value;
            const bottomCard = document.getElementById('player-bottom-card').value;

            const campEl = document.getElementById('current-camp');
            
            if (!topCard || !bottomCard) {
                campEl.textContent = '-';
                return;
            }

            const topRole = ROLES[topCard];
            const campText = topRole.camp === 'wolf' ? 'ğŸº ç‹¼äººé˜µè¥' : 'ğŸ‘¥ å¥½äººé˜µè¥';
            const campColor = topRole.camp === 'wolf' ? '#e74c3c' : '#27ae60';
            
            campEl.textContent = campText;
            campEl.style.color = campColor;
        }

        async function confirmPlayerSelection() {
            const topCard = document.getElementById('player-top-card').value;
            const bottomCard = document.getElementById('player-bottom-card').value;

            if (!topCard || !bottomCard) {
                alert('âŒ è¯·é€‰æ‹©ä¸Šç‰Œå’Œä¸‹ç‰Œï¼');
                return;
            }

            const topRole = ROLES[topCard];
            const bottomRole = ROLES[bottomCard];
            
            if (!confirm(`ç¡®è®¤ä½ çš„é€‰æ‹©ï¼Ÿ\n\nä¸Šç‰Œï¼š${topRole.emoji} ${topRole.name}\nä¸‹ç‰Œï¼š${bottomRole.emoji} ${bottomRole.name}\n\nç¡®è®¤åæ— æ³•ä¿®æ”¹ï¼`)) {
                return;
            }

            try {
                const data = playerState.gameObject.get('data');
                data.selections[playerState.playerNumber] = {
                    top: topCard,
                    bottom: bottomCard,
                    confirmed: true
                };
                
                playerState.gameObject.set('data', data);
                await playerState.gameObject.save();

                document.getElementById('selection-area').classList.add('hidden');
                document.getElementById('confirmed-area').classList.remove('hidden');
                
                playerState.confirmed = true;
                playerState.topCard = topCard;
                playerState.bottomCard = bottomCard;
                
                alert('âœ… é€‰æ‹©å·²ä¿å­˜ï¼\nç­‰å¾…æ³•å®˜å¼€å§‹æ¸¸æˆ...');
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        }

        function playerLogout() {
            playerState = {
                sessionId: null,
                playerNumber: null,
                cards: [],
                topCard: null,
                bottomCard: null,
                confirmed: false
            };
            
            document.getElementById('player-session-id').value = '';
            document.getElementById('player-number').value = '';
            document.getElementById('player-password').value = '';
            
            document.getElementById('player-selection-section').classList.add('hidden');
            document.getElementById('player-login-section').classList.remove('hidden');
        }

        // ==================== é¡µé¢åŠ è½½ ====================
        
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            
            if (mode === 'player') {
                selectMode('player');
            }
        });
    </script>
</body>
</html>
